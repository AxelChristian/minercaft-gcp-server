<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minecraft Server Control</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top, #1f2937 0, #020617 40%, #000 100%);
      --card-bg: rgba(15, 23, 42, 0.9);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.12);
      --warning: #eab308;
      --warning-soft: rgba(234, 179, 8, 0.12);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.2);
      --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.85);
      --radius-xl: 20px;
      --radius-pill: 999px;
      --transition-fast: 150ms ease-out;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-gradient);
      color: var(--text-main);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 24px;
    }

    .shell { width: 100%; max-width: 960px; }

    .title-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-main {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .title-main h1 {
      font-size: 1.4rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .title-main span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .badge-env {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #38bdf8;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      padding: 22px 22px 18px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      gap: 22px;
    }

    @media (max-width: 780px) {
      .card { grid-template-columns: minmax(0, 1fr); }
    }

    .status-pane {
      border-right: 1px solid rgba(148, 163, 184, 0.25);
      padding-right: 18px;
    }

    @media (max-width: 780px) {
      .status-pane {
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        padding-right: 0;
        padding-bottom: 18px;
      }
    }

    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 10px;
    }

    .status-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      font-size: 0.8rem;
      font-weight: 500;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .status-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      background: #6b7280;
      box-shadow: 0 0 0 4px rgba(75, 85, 99, 0.25);
    }

    .status-pill.online {
      border-color: rgba(34, 197, 94, 0.6);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .status-pill.online .status-dot {
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    .status-pill.offline {
      border-color: rgba(239, 68, 68, 0.6);
      background: var(--danger-soft);
      color: var(--danger);
    }

    .status-pill.offline .status-dot {
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.18);
    }

    .status-pill.unknown {
      border-color: rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    .status-pill.unknown .status-dot {
      background: #6b7280;
      box-shadow: 0 0 0 4px rgba(75, 85, 99, 0.25);
    }

    .status-body {
      display: flex;
      gap: 18px;
      align-items: center;
      margin-bottom: 14px;
    }

    .status-gauge {
      width: 82px;
      height: 82px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0%, #1f2937 0, #020617 55%, #000 100%);
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.95), inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      position: relative;
    }

    .status-gauge::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      border: 4px solid rgba(55, 65, 81, 0.7);
      border-top-color: rgba(34, 197, 94, 0.9);
      opacity: 0.7;
    }

    .status-gauge span {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .status-meta { flex: 1; min-width: 0; }

    .meta-line { font-size: 0.85rem; margin-bottom: 6px; }

    .meta-label { color: var(--text-muted); margin-right: 6px; }

    .meta-value {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.82rem;
    }

    .meta-ip {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .meta-chip-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .meta-ip .meta-value { font-size: 0.82rem; }

    .last-updated {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .status-chip-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .mini-chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .controls-pane {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .group-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .token-group { display: flex; flex-direction: column; gap: 8px; }

    .token-row { display: flex; gap: 10px; }
    @media (max-width: 600px) { .token-row { flex-direction: column; } }

    .input {
      flex: 1;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 8px 12px;
      font-size: 0.85rem;
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .input::placeholder { color: rgba(148, 163, 184, 0.75); }

    .input:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
      background: rgba(15, 23, 42, 0.95);
    }

    .hint { font-size: 0.75rem; color: var(--text-muted); }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast), opacity var(--transition-fast);
      outline: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.5);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(34, 197, 94, 0.6);
    }
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.5);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.8);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.8);
      color: var(--warning);
      border: 1px solid rgba(234, 179, 8, 0.4);
    }
    .btn-ghost:hover {
      background: var(--warning-soft);
      box-shadow: 0 10px 24px rgba(234, 179, 8, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-icon-spin {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 0.3);
      border-top-color: #f9fafb;
      animation: spin 0.7s linear infinite;
    }

    .btn-row { display: flex; flex-wrap: wrap; gap: 8px; }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-main);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.9);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 150ms ease-out, transform 150ms ease-out;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 40;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .toast-dot {
      width: 8px; height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .toast-error .toast-dot { background: #ef4444; }
    .toast-warn .toast-dot { background: #eab308; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* LOGIN OVERLAY */
    .lock-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(0,0,0,0.98));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .lock-card {
      width: 100%;
      max-width: 420px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.95);
      padding: 22px 22px 18px;
    }

    .lock-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .lock-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .lock-footer {
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .lock-tag {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="lock-overlay" class="lock-overlay">
    <div class="lock-card">
      <div class="lock-title">Restricted Panel</div>
      <div class="lock-sub">
        Masukkan <strong>Access Password</strong> untuk membuka kontrol Minecraft server.
      </div>
      <div class="token-row" style="margin-bottom: 8px;">
        <input
          id="login-password-input"
          class="input"
          type="password"
          autocomplete="off"
          placeholder="Enter access password"
        />
        <button id="btn-login" class="btn btn-primary">
          Unlock
        </button>
      </div>
      <div class="hint">
        Panel ini hanya untuk internal. Password ini berbeda dengan token API Cloud Run.
      </div>
      <div class="lock-footer">
        <div class="lock-tag">vm-controller</div>
        <div>GCP · asia-southeast2</div>
      </div>
    </div>
  </div>

  <!-- MAIN PANEL -->
  <div class="shell" id="main-shell" style="opacity:0.15; pointer-events:none; filter:blur(2px);">
    <div class="title-bar">
      <div class="title-main">
        <h1>Minecraft Server Control</h1>
        <span>GCP · asia-southeast2</span>
      </div>
      <div class="badge-env">
        <span class="badge-dot"></span>
        Cloud Run · VM Bridge
      </div>
    </div>

    <div class="card">
      <!-- STATUS SIDE -->
      <div class="status-pane">
        <div class="status-header">
          <div>
            <div class="status-title">Server status</div>
          </div>
          <div id="status-pill" class="status-pill unknown">
            <span class="status-dot"></span>
            <span id="status-text">Unknown</span>
          </div>
        </div>

        <div class="status-body">
          <div class="status-gauge">
            <span id="status-gauge-text">--</span>
          </div>
          <div class="status-meta">
            <div class="meta-line">
              <span class="meta-label">Instance:</span>
              <span class="meta-value" id="meta-instance">-</span>
            </div>
            <div class="meta-line">
              <span class="meta-label">Region:</span>
              <span class="meta-value">asia-southeast2-a</span>
            </div>
            <div class="meta-line">
              <div class="meta-ip">
                <span class="meta-chip-label">EXTERNAL IP</span>
                <span class="meta-value" id="meta-ip">–</span>
              </div>
            </div>
            <div class="last-updated" id="last-updated">
              Last updated: – 
            </div>
          </div>
        </div>

        <div class="status-chip-row">
          <div class="mini-chip" id="mini-state">State: —</div>
          <div class="mini-chip" id="mini-health">API: Connected</div>
        </div>
      </div>

      <!-- CONTROLS SIDE -->
      <div class="controls-pane">
        <div class="token-group">
          <div class="group-label">Access token</div>
          <div class="token-row">
            <input
              id="token-input"
              class="input"
              type="password"
              autocomplete="off"
              placeholder="Enter API token"
            />
            <button class="btn btn-outline" id="btn-set-token">
              Use token
            </button>
          </div>
          <div class="hint">
            Token diset di Cloud Run (<code>CONTROL_TOKEN</code>). 
            Halaman ini tidak menyimpan token, hanya dipakai di sesi ini.
          </div>
        </div>

        <div>
          <div class="group-label" style="margin-bottom: 8px;">Controls</div>
          <div class="btn-row">
            <button class="btn btn-primary" id="btn-start">
              <span id="btn-start-icon">▶</span>
              <span>Start</span>
            </button>
            <button class="btn btn-ghost" id="btn-stop">
              <span id="btn-stop-icon">■</span>
              <span>Stop</span>
            </button>
            <button class="btn btn-outline" id="btn-refresh">
              ⟳ Refresh status
            </button>
          </div>
          <div class="hint" style="margin-top: 6px;">
            Start/Stop akan mengirim request ke Cloud Run → Compute Engine. 
            Butuh beberapa detik sampai VM benar-benar up/down.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <span class="toast-dot"></span>
    <span id="toast-text"></span>
  </div>

  <script>
    // GANTI PASSWORD LOGIN DI SINI
    const LOGIN_PASSWORD = "alek1212"; 
    const API_BASE = "https://vm-controller-797194990052.asia-southeast2.run.app";

    let currentToken = "";
    let isBusy = false;
    let isUnlocked = false;

    const els = {
      lockOverlay: document.getElementById("lock-overlay"),
      loginPasswordInput: document.getElementById("login-password-input"),
      btnLogin: document.getElementById("btn-login"),
      mainShell: document.getElementById("main-shell"),

      statusPill: document.getElementById("status-pill"),
      statusText: document.getElementById("status-text"),
      statusGaugeText: document.getElementById("status-gauge-text"),
      metaInstance: document.getElementById("meta-instance"),
      metaIp: document.getElementById("meta-ip"),
      lastUpdated: document.getElementById("last-updated"),
      miniState: document.getElementById("mini-state"),
      btnStart: document.getElementById("btn-start"),
      btnStop: document.getElementById("btn-stop"),
      btnRefresh: document.getElementById("btn-refresh"),
      btnSetToken: document.getElementById("btn-set-token"),
      tokenInput: document.getElementById("token-input"),
      toast: document.getElementById("toast"),
      toastText: document.getElementById("toast-text"),
      btnStartIcon: document.getElementById("btn-start-icon"),
      btnStopIcon: document.getElementById("btn-stop-icon"),
    };

    function setBusy(busy) {
      isBusy = busy;
      [els.btnStart, els.btnStop, els.btnRefresh].forEach(btn => {
        btn.disabled = busy || !currentToken || !isUnlocked;
      });

      if (busy) {
        els.btnStartIcon.innerHTML = "";
        els.btnStartIcon.className = "btn-icon-spin";
        els.btnStopIcon.innerHTML = "";
        els.btnStopIcon.className = "btn-icon-spin";
      } else {
        els.btnStartIcon.className = "";
        els.btnStartIcon.textContent = "▶";
        els.btnStopIcon.className = "";
        els.btnStopIcon.textContent = "■";
      }
    }

    function showToast(message, type = "info") {
      els.toastText.textContent = message;
      els.toast.classList.remove("toast-error", "toast-warn");
      if (type === "error") els.toast.classList.add("toast-error");
      if (type === "warn") els.toast.classList.add("toast-warn");
      els.toast.classList.add("show");
      setTimeout(() => els.toast.classList.remove("show"), 3200);
    }

    function formatDate(d) {
      return (
        d.toLocaleDateString(undefined, {
          day: "2-digit",
          month: "short",
          year: "numeric",
        }) +
        " · " +
        d.toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        })
      );
    }

    function updateStatusUI(data) {
      const status = (data.status || "UNKNOWN").toUpperCase();
      const ip = data.ip || "—";
      const instance = data.instance || "minecraft-server";

      els.metaInstance.textContent = instance;
      els.metaIp.textContent = ip;
      els.lastUpdated.textContent = "Last updated: " + formatDate(new Date());

      let pillClass = "unknown";
      let gaugeText = "--";
      let label = "Unknown";

      if (status === "RUNNING") {
        pillClass = "online";
        gaugeText = "ON";
        label = "Online";
      } else if (["STOPPING", "PROVISIONING", "STAGING"].includes(status)) {
        pillClass = "unknown";
        gaugeText = "..";
        label = status;
      } else if (status === "TERMINATED" || status === "STOPPED") {
        pillClass = "offline";
        gaugeText = "OFF";
        label = "Offline";
      }

      els.statusPill.classList.remove("online", "offline", "unknown");
      els.statusPill.classList.add(pillClass);
      els.statusText.textContent = label;
      els.statusGaugeText.textContent = gaugeText;
      els.miniState.textContent = "State: " + status;
    }

    async function callApi(path, method = "GET") {
      if (!isUnlocked) {
        showToast("Panel masih terkunci. Masukkan access password dulu.", "warn");
        return null;
      }
      if (!currentToken) {
        showToast("Set token dulu sebelum kontrol server.", "warn");
        return null;
      }

      try {
        setBusy(true);
        const url = `${API_BASE}${path}?token=${encodeURIComponent(currentToken)}`;
        const res = await fetch(url, { method });
        const data = await res.json();
        if (!res.ok) {
          const msg = data && data.error ? data.error : res.statusText;
          showToast("API error: " + msg, "error");
        }
        return data;
      } catch (e) {
        console.error(e);
        showToast("Network error, cek koneksi / Cloud Run.", "error");
        return null;
      } finally {
        setBusy(false);
      }
    }

    async function refreshStatus() {
      const data = await callApi("/status", "GET");
      if (data) updateStatusUI(data);
    }

    async function startServer() {
      const data = await callApi("/start", "POST");
      if (data) {
        showToast("Start request dikirim ke VM.", "info");
        setTimeout(refreshStatus, 3000);
      }
    }

    async function stopServer() {
      const data = await callApi("/stop", "POST");
      if (data) {
        showToast("Stop request dikirim ke VM.", "info");
        setTimeout(refreshStatus, 3000);
      }
    }

    // LOGIN
    function unlockPanel() {
      const value = els.loginPasswordInput.value.trim();
      if (!value) {
        showToast("Password tidak boleh kosong.", "warn");
        return;
      }
      if (value !== LOGIN_PASSWORD) {
        showToast("Password salah.", "error");
        els.loginPasswordInput.value = "";
        els.loginPasswordInput.focus();
        return;
      }
      isUnlocked = true;
      els.lockOverlay.style.display = "none";
      els.mainShell.style.opacity = "1";
      els.mainShell.style.pointerEvents = "auto";
      els.mainShell.style.filter = "none";
      showToast("Panel unlocked. Silakan set token API.", "info");
      setBusy(false);
    }

    els.btnLogin.addEventListener("click", unlockPanel);
    els.loginPasswordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") unlockPanel();
    });

    // TOKEN
    els.btnSetToken.addEventListener("click", () => {
      if (!isUnlocked) {
        showToast("Unlock panel dulu sebelum set token.", "warn");
        return;
      }
      const value = els.tokenInput.value.trim();
      if (!value) {
        showToast("Token tidak boleh kosong.", "warn");
        return;
      }
      currentToken = value;
      showToast("Token aktif. Siap mengontrol server.", "info");
      setBusy(false);
      refreshStatus();
    });

    els.tokenInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") els.btnSetToken.click();
    });

    els.btnRefresh.addEventListener("click", refreshStatus);
    els.btnStart.addEventListener("click", startServer);
    els.btnStop.addEventListener("click", stopServer);

    // initial
    setBusy(false);
  </script>
</body>
</html>
